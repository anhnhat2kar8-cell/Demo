local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local workspace = game:GetService("Workspace")

local lp = Players.LocalPlayer
local guiParent = lp:WaitForChild("PlayerGui")

-- Hàm lấy character (thay đổi khi respawn)
local function getCharacter()
    return lp.Character or lp.CharacterAdded:Wait()
end

local chr = getCharacter()
local hum = chr:FindFirstChild("Humanoid") or chr:WaitForChild("Humanoid")
local hrp = chr:FindFirstChild("HumanoidRootPart") or chr:WaitForChild("HumanoidRootPart")

-- Biến chính
local farming = false
local radius = 22
local speed = 2
local autoAttack = true
local autoLoot = true
local autoHeal = true

-- ====== GUI chính ======
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ZENX_GUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = guiParent

-- Main Frame
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 260, 0, 180)
MainFrame.Position = UDim2.new(0.04, 0, 0.25, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
MainFrame.BackgroundTransparency = 0.32
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 10)
mainCorner.Parent = MainFrame

-- Title
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 36)
Title.Position = UDim2.new(0, 0, 0, 6)
Title.BackgroundTransparency = 1
Title.Text = "💀 ZENX 💀"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 20
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextXAlignment = Enum.TextXAlignment.Center
Title.Parent = MainFrame

-- Farm Button
local FarmButton = Instance.new("TextButton")
FarmButton.Size = UDim2.new(1, -24, 0, 38)
FarmButton.Position = UDim2.new(0, 12, 0, 48)
FarmButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
FarmButton.BackgroundTransparency = 0.38
FarmButton.Text = "Bật Farm Boss"
FarmButton.Font = Enum.Font.GothamBold
FarmButton.TextSize = 20
FarmButton.TextColor3 = Color3.fromRGB(255,255,255)
FarmButton.Parent = MainFrame

local farmCorner = Instance.new("UICorner")
farmCorner.CornerRadius = UDim.new(0, 8)
farmCorner.Parent = FarmButton

-- Hàm tạo ô nhập giá trị
local function createEditableLabel(yPos, labelText, getValue, setValue)
    local LabelButton = Instance.new("TextButton")
    LabelButton.Size = UDim2.new(1, -24, 0, 34)
    LabelButton.Position = UDim2.new(0, 12, 0, yPos)
    LabelButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    LabelButton.BackgroundTransparency = 0.38
    LabelButton.Font = Enum.Font.Gotham
    LabelButton.TextSize = 18
    LabelButton.TextColor3 = Color3.fromRGB(245, 245, 245)
    LabelButton.TextXAlignment = Enum.TextXAlignment.Center
    LabelButton.Text = labelText .. " (VD: " .. tostring(getValue()) .. ")"
    LabelButton.Parent = MainFrame
    Instance.new("UICorner", LabelButton).CornerRadius = UDim.new(0, 8)

    LabelButton.MouseButton1Click:Connect(function()
        local TempBox = Instance.new("TextBox")
        TempBox.Size = LabelButton.Size
        TempBox.Position = LabelButton.Position
        TempBox.BackgroundColor3 = Color3.fromRGB(40,40,40)
        TempBox.BackgroundTransparency = 0.38
        TempBox.Font = Enum.Font.Gotham
        TempBox.TextSize = 18
        TempBox.TextColor3 = Color3.fromRGB(245,245,245)
        TempBox.ClearTextOnFocus = false
        TempBox.TextXAlignment = Enum.TextXAlignment.Center
        TempBox.Text = tostring(getValue())
        TempBox.Parent = MainFrame
        Instance.new("UICorner", TempBox).CornerRadius = UDim.new(0, 8)
        TempBox:CaptureFocus()

        TempBox.FocusLost:Connect(function()
            local num = tonumber(TempBox.Text)
            if num then setValue(num) end
            LabelButton.Text = labelText .. " (VD: " .. tostring(getValue()) .. ")"
            TempBox:Destroy()
        end)
    end)
end

-- Nhập khoảng cách & tốc độ vòng
createEditableLabel(96, "Khoảng cách", function() return radius end, function(v) radius = v end)
createEditableLabel(136, "Tốc độ vòng", function() return speed end, function(v) speed = v end)

-- ====== Thanh máu Boss (trên đầu) ======
local billboardGui = Instance.new("BillboardGui")
billboardGui.Name = "BossHealthBar"
billboardGui.Size = UDim2.new(6, 0, 1, 0)
billboardGui.AlwaysOnTop = true
billboardGui.ExtentsOffset = Vector3.new(0, 4.5, 0)
billboardGui.Adornee = nil
billboardGui.Parent = workspace

local bossLabel = Instance.new("TextLabel")
bossLabel.Size = UDim2.new(1, 0, 0.4, 0)
bossLabel.Position = UDim2.new(0, 0, 0, -18)
bossLabel.BackgroundTransparency = 1
bossLabel.Text = "BOSS"
bossLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
bossLabel.Font = Enum.Font.GothamBold
bossLabel.TextScaled = true
bossLabel.Parent = billboardGui

local bgFrame = Instance.new("Frame")
bgFrame.Size = UDim2.new(1, 0, 0.25, 0)
bgFrame.Position = UDim2.new(0, 0, 0.5, 0)
bgFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
bgFrame.BackgroundTransparency = 0.3
bgFrame.BorderSizePixel = 0
bgFrame.Parent = billboardGui
Instance.new("UICorner", bgFrame).CornerRadius = UDim.new(0, 6)

local healthBar = Instance.new("Frame")
healthBar.Size = UDim2.new(1, 0, 1, 0)
healthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
healthBar.BorderSizePixel = 0
healthBar.Parent = bgFrame
Instance.new("UICorner", healthBar).CornerRadius = UDim.new(0, 6)

local healthText = Instance.new("TextLabel")
healthText.Size = UDim2.new(1, 0, 1, 0)
healthText.BackgroundTransparency = 1
healthText.TextColor3 = Color3.new(1,1,1)
healthText.Font = Enum.Font.GothamBold
healthText.TextScaled = true
healthText.TextStrokeTransparency = 0.7
healthText.Parent = bgFrame

-- Update boss HP
task.spawn(function()
    while task.wait(0.1) do
        local target = nil
        for _, v in pairs(workspace:GetDescendants()) do
            if v:IsA("Model") and v:FindFirstChild("Humanoid") and v ~= chr and v:FindFirstChild("HumanoidRootPart") then
                if v.Humanoid.Health > 0 then
                    target = v
                    break
                end
            end
        end

        if target then
            billboardGui.Adornee = target.HumanoidRootPart
            local currentHP = target.Humanoid.Health
            local maxHP = target.Humanoid.MaxHealth
            local pct = math.clamp(currentHP / maxHP, 0, 1)

            -- Đổi màu theo % máu
            if pct > 0.6 then
                healthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
            elseif pct > 0.3 then
                healthBar.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
            else
                healthBar.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
            end

            healthBar:TweenSize(UDim2.new(pct, 0, 1, 0), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.1, true)
            healthText.Text = string.format("%d / %d (%.0f%%)", math.floor(currentHP), math.floor(maxHP), pct*100)
        else
            billboardGui.Adornee = nil
        end
    end
end)

-- Auto heal
task.spawn(function()
    while task.wait(0.6) do
        if autoHeal then
            chr = getCharacter()
            hum = chr:FindFirstChild("Humanoid") or hum
            hrp = chr:FindFirstChild("HumanoidRootPart") or hrp
            if hum and hum.Health and hum.Health < 80 then
                local tool = lp.Character and lp.Character:FindFirstChildOfClass("Tool")
                local lastWeapon = nil
                if tool and not tool.Name:lower():find("băng") then
                    lastWeapon = tool
                end
                for _, t in ipairs(lp.Backpack:GetChildren()) do
                    if t:IsA("Tool") and t.Name:lower():find("băng") then
                        t.Parent = lp.Character
                        task.wait(0.15)
                        local healTool = lp.Character:FindFirstChildWhichIsA("Tool")
                        if healTool and healTool.Name:lower():find("băng") then
                            pcall(function() healTool:Activate() end)
                            task.wait(1)
                            if lastWeapon and lastWeapon.Parent == lp.Backpack then
                                lastWeapon.Parent = lp.Character
                            end
                        end
                        break
                    end
                end
            end
        end
    end
end)

-- Auto loot
task.spawn(function()
    while task.wait(0.5) do
        if autoLoot then
            chr = getCharacter()
            hrp = chr:FindFirstChild("HumanoidRootPart") or hrp
            if hrp then
                for _, prompt in pairs(workspace:GetDescendants()) do
                    if prompt:IsA("ProximityPrompt") then
                        local ok, pos = pcall(function() return prompt.Parent.Position end)
                        if ok and pos and (hrp.Position - pos).Magnitude <= 16 then
                            pcall(function() fireproximityprompt(prompt) end)
                            task.wait(0.12)
                        end
                    end
                end
            end
        end
    end
end)

-- Auto attack
local function attack()
    local tool = lp.Character and lp.Character:FindFirstChildOfClass("Tool")
    if tool then
        pcall(function() tool:Activate() end)
    end
end

-- Di chuyển quanh boss
RunService.Heartbeat:Connect(function()
    if farming then
        local target = nil
        for _, v in pairs(workspace:GetDescendants()) do
            if v:IsA("Model") and v:FindFirstChild("Humanoid") and v ~= chr and v:FindFirstChild("HumanoidRootPart") then
                if v.Humanoid.Health > 0 then
                    target = v
                    break
                end
            end
        end

        if target and target:FindFirstChild("HumanoidRootPart") then
            local thrp = target.HumanoidRootPart
            local angle = tick() * (tonumber(speed) or 2)
            local off = Vector3.new(math.cos(angle) * (tonumber(radius) or 22), 0, math.sin(angle) * (tonumber(radius) or 22))
            local goalPos = thrp.Position + off
            local ok, tween = pcall(function()
                return TweenService:Create(hrp, TweenInfo.new(0.12, Enum.EasingStyle.Linear), {CFrame = CFrame.new(goalPos, thrp.Position)})
            end)
            if ok and tween then
                tween:Play()
            else
                pcall(function() hrp.CFrame = CFrame.new(goalPos, thrp.Position) end)
            end
            if hum then pcall(function() hum.AutoRotate = false end) end
            if autoAttack then attack() end
        end
    else
        if hum then pcall(function() hum.AutoRotate = true end) end
    end
end)

-- Nút bật/tắt farm
FarmButton.MouseButton1Click:Connect(function()
    farming = not farming
    FarmButton.Text = farming and "Tắt Farm Boss" or "Bật Farm Boss"
end)

-- Khi respawn
lp.CharacterAdded:Connect(function(char)
    chr = char
    hum = chr:WaitForChild("Humanoid")
    hrp = chr:WaitForChild("HumanoidRootPart")
end)
