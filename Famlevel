--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")
local LP = Players.LocalPlayer

--// CHARACTER
local Char = LP.Character or LP.CharacterAdded:Wait()
local HRP = Char:WaitForChild("HumanoidRootPart")
local Hum = Char:WaitForChild("Humanoid")

LP.CharacterAdded:Connect(function(c)
    Char = c
    HRP = c:WaitForChild("HumanoidRootPart")
    Hum = c:WaitForChild("Humanoid")
end)

--// SETTINGS
local FARM = true
local HEIGHT = 3
local ATTACK_DELAY = 0.12

--// NOCLIP
RunService.Stepped:Connect(function()
    if not Char then return end
    for _,v in pairs(Char:GetDescendants()) do
        if v:IsA("BasePart") then
            v.CanCollide = false
        end
    end
end)

--// CHECK NPC GIANG HO DI DUONG
local function isTarget(m)
    return m:IsA("Model")
    and m:FindFirstChildWhichIsA("Humanoid")
    and not Players:GetPlayerFromCharacter(m)
    and m:FindFirstChildWhichIsA("BasePart")
    and m:FindFirstChildWhichIsA("Humanoid").Health > 0
end

--// GET NEAREST TARGET
local function getNearest()
    local nearest, dist = nil, math.huge
    for _,m in pairs(workspace:GetDescendants()) do
        if isTarget(m) then
            local part = m:FindFirstChildWhichIsA("BasePart")
            local d = (HRP.Position - part.Position).Magnitude
            if d < dist then
                dist = d
                nearest = m
            end
        end
    end
    return nearest
end

--// AUTO ATTACK
task.spawn(function()
    while FARM do
        VirtualUser:Button1Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        task.wait(ATTACK_DELAY)
        VirtualUser:Button1Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        task.wait(ATTACK_DELAY)
    end
end)

--// MAIN FARM LOOP
task.spawn(function()
    while FARM do
        local target = getNearest()
        if target then
            local hum = target:FindFirstChildWhichIsA("Humanoid")
            local part = target:FindFirstChildWhichIsA("BasePart")

            while hum and hum.Health > 0 and FARM do
                HRP.CFrame = part.CFrame * CFrame.new(0, HEIGHT, 0)
                task.wait()
            end
        end
        task.wait(0.2)
    end
end)
