--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")

local LP = Players.LocalPlayer
local Char = LP.Character or LP.CharacterAdded:Wait()
local HRP = Char:WaitForChild("HumanoidRootPart")

LP.CharacterAdded:Connect(function(c)
    Char = c
    HRP = c:WaitForChild("HumanoidRootPart")
end)

--// SETTINGS
local FARM = true
local HEIGHT = 3.2
local SPEED = 0.08

--// NOCLIP (KHÔNG NHẢY / KHÔNG VƯỚNG)
RunService.Stepped:Connect(function()
    if not Char then return end
    for _,v in pairs(Char:GetDescendants()) do
        if v:IsA("BasePart") then
            v.CanCollide = false
        end
    end
end)

--// GIẢ LẬP CLICK (GAME CẦN)
LP.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)

--// NHẬN DIỆN GIANG HỒ (CHUẨN)
local function isTarget(model)
    if not model:IsA("Model") then return false end
    if Players:GetPlayerFromCharacter(model) then return false end

    local hum = model:FindFirstChildOfClass("Humanoid")
    local hrp = model:FindFirstChild("HumanoidRootPart")
    if not hum or not hrp then return false end
    if hum.Health <= 0 then return false end

    -- loại NPC tĩnh (shop, quest)
    if model.Name:lower():find("npc") then return false end

    return true
end

--// TÌM GIANG HỒ GẦN NHẤT
local function getNearest()
    local nearest, dist
    for _,v in pairs(workspace:GetChildren()) do
        if isTarget(v) then
            local d = (v.HumanoidRootPart.Position - HRP.Position).Magnitude
            if d < 60 and (not dist or d < dist) then
                dist = d
                nearest = v
            end
        end
    end
    return nearest
end

--// FARM LOOP (DÍNH TRÊN ĐẦU)
task.spawn(function()
    while task.wait(SPEED) do
        if FARM and Char and HRP then
            local npc = getNearest()
            if npc and npc:FindFirstChild("HumanoidRootPart") then
                local nhrp = npc.HumanoidRootPart

                HRP.CFrame = CFrame.new(
                    nhrp.Position + Vector3.new(0, HEIGHT, 0),
                    nhrp.Position
                )

                -- đánh
                local tool = Char:FindFirstChildOfClass("Tool")
                if tool then
                    pcall(function()
                        tool:Activate()
                    end)
                end
            end
        end
    end
end)
