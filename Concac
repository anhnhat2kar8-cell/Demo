local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local lp = Players.LocalPlayer
local guiParent = lp:WaitForChild("PlayerGui")

-- === Character refs (cập nhật khi respawn) ===
local function getCharacter()
    return lp.Character or lp.CharacterAdded:Wait()
end

-- === GUI Menu Auto ===
local ScreenGui = Instance.new("ScreenGui", guiParent)
ScreenGui.ResetOnSpawn = false

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 220, 0, 180)
Frame.Position = UDim2.new(0, 50, 0, 200)
Frame.BackgroundColor3 = Color3.fromRGB(60, 0, 0)
Frame.Active = true
Frame.Draggable = true

local UICorner = Instance.new("UICorner", Frame)
UICorner.CornerRadius = UDim.new(0, 12)

local title = Instance.new("TextLabel", Frame)
title.Size = UDim2.new(1, 0, 0, 30)
title.Text = "Menu Auto"
title.TextColor3 = Color3.new(1, 1, 1)
title.BackgroundTransparency = 1
title.Font = Enum.Font.SourceSansBold
title.TextSize = 20

-- Buttons
local function createBtn(name, y)
    local btn = Instance.new("TextButton", Frame)
    btn.Size = UDim2.new(1, -20, 0, 30)
    btn.Position = UDim2.new(0, 10, 0, y)
    btn.Text = name.." OFF"
    btn.BackgroundColor3 = Color3.fromRGB(120, 0, 0)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.SourceSans
    btn.TextSize = 18
    local corner = Instance.new("UICorner", btn)
    corner.CornerRadius = UDim.new(0, 8)
    return btn
end

local btnFarm = createBtn("Auto Farm Boss", 40)
local btnFly = createBtn("Bay Waypoint", 80)
local btnItem = createBtn("Auto Nhặt Item", 120)

-- === Trạng thái ===
_G.AutoFarm = false
_G.FlyWaypoint = false
_G.AutoItem = false

-- === Tìm boss gần nhất ===
local function getNearestBoss()
    local nearest, dist = nil, math.huge
    for _, mob in ipairs(Workspace:GetChildren()) do
        if mob:FindFirstChild("Humanoid") and mob:FindFirstChild("HumanoidRootPart") and mob.Name:find("Boss") then
            local d = (mob.HumanoidRootPart.Position - getCharacter().HumanoidRootPart.Position).Magnitude
            if d < dist then
                nearest, dist = mob, d
            end
        end
    end
    return nearest
end

-- === Auto Farm Boss ===
local function autoFarm()
    coroutine.wrap(function()
        while true do
            if _G.AutoFarm then
                local boss = getNearestBoss()
                if boss and boss:FindFirstChild("HumanoidRootPart") then
                    local hrp = getCharacter():WaitForChild("HumanoidRootPart")
                    hrp.CFrame = boss.HumanoidRootPart.CFrame * CFrame.new(0, 0, -5)
                    -- Gọi sự kiện đánh boss nếu có (thay bằng remote của game)
                end
            end
            task.wait(0.2)
        end
    end)()
end
autoFarm()

-- === Bay quanh boss xa hơn (tránh bị đánh) ===
local function flyAroundBoss(boss)
    local chr = getCharacter()
    local hrp = chr:WaitForChild("HumanoidRootPart")

    coroutine.wrap(function()
        local radius = 30 -- khoảng cách bay vòng
        local heightOffset = 5
        local speed = 2

        while _G.FlyWaypoint and boss and boss.Parent do
            local bossPos = boss.HumanoidRootPart.Position
            local angle = tick() * speed
            local x = bossPos.X + math.cos(angle) * radius
            local z = bossPos.Z + math.sin(angle) * radius
            local y = bossPos.Y + heightOffset

            hrp.CFrame = CFrame.new(Vector3.new(x, y, z), bossPos)

            task.wait(0.05)
        end
    end)()
end

-- === Auto nhặt item rơi ===
local function autoCollect()
    coroutine.wrap(function()
        while true do
            if _G.AutoItem then
                for _, obj in ipairs(Workspace:GetChildren()) do
                    if obj:IsA("Tool") or obj.Name:find("Drop") then
                        local hrp = getCharacter():WaitForChild("HumanoidRootPart")
                        hrp.CFrame = obj.CFrame
                        task.wait(0.2)
                    end
                end
            end
            task.wait(1)
        end
    end)()
end
autoCollect()

-- === Toggle Buttons ===
btnFarm.MouseButton1Click:Connect(function()
    _G.AutoFarm = not _G.AutoFarm
    btnFarm.Text = "Auto Farm Boss "..(_G.AutoFarm and "ON" or "OFF")
end)

btnFly.MouseButton1Click:Connect(function()
    _G.FlyWaypoint = not _G.FlyWaypoint
    btnFly.Text = "Bay Waypoint "..(_G.FlyWaypoint and "ON" or "OFF")
    if _G.FlyWaypoint then
        local boss = getNearestBoss()
        if boss then flyAroundBoss(boss) end
    end
end)

btnItem.MouseButton1Click:Connect(function()
    _G.AutoItem = not _G.AutoItem
    btnItem.Text = "Auto Nhặt Item "..(_G.AutoItem and "ON" or "OFF")
end)
