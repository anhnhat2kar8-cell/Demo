local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local lp = Players.LocalPlayer
local guiParent = lp:WaitForChild("PlayerGui")

-- ==== Character refs (update khi respawn) ====
local function getCharacter()
    return lp.Character or lp.CharacterAdded:Wait()
end

-- ==== GUI ====
local ScreenGui = Instance.new("ScreenGui", guiParent)
ScreenGui.ResetOnSpawn = false

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 220, 0, 180)
Frame.Position = UDim2.new(0.05, 0, 0.4, 0)
Frame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
Frame.BackgroundTransparency = 0.2
Frame.Active = true
Frame.Draggable = true

local title = Instance.new("TextLabel", Frame)
title.Text = "Menu Auto"
title.Size = UDim2.new(1, 0, 0, 30)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 20

local function makeBtn(text, order)
    local btn = Instance.new("TextButton", Frame)
    btn.Size = UDim2.new(1, -20, 0, 30)
    btn.Position = UDim2.new(0, 10, 0, 30 + (order * 35))
    btn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 18
    btn.Text = text.." OFF"
    return btn
end

local farmBtn = makeBtn("Auto Farm Boss",0)
local flyBtn = makeBtn("Bay Waypoint",1)
local itemBtn = makeBtn("Auto Nhặt Item",2)

-- ==== Biến toggle ====
_G.AutoFarm = false
_G.FlyWaypoint = false
_G.AutoItem = false

-- ==== Hàm tìm boss gần nhất ====
local function getNearestBoss()
    local nearest, dist = nil, math.huge
    for _,npc in pairs(Workspace:GetChildren()) do
        if npc:FindFirstChild("Humanoid") and npc:FindFirstChild("HumanoidRootPart") and npc.Name:find("NPC") then
            local d = (npc.HumanoidRootPart.Position - getCharacter().HumanoidRootPart.Position).Magnitude
            if d < dist then
                dist = d
                nearest = npc
            end
        end
    end
    return nearest
end

-- ==== Auto Farm Boss ====
coroutine.wrap(function()
    while task.wait(0.2) do
        if _G.AutoFarm then
            local boss = getNearestBoss()
            if boss and boss:FindFirstChild("HumanoidRootPart") then
                local hrp = getCharacter():WaitForChild("HumanoidRootPart")
                hrp.CFrame = boss.HumanoidRootPart.CFrame * CFrame.new(0,0, -5)
                -- đánh boss (giả lập click)
                mouse1click()
            end
        end
    end
end)()

-- ==== Bay quanh boss ngang tầm ====
local function flyAroundBoss(boss)
    local chr = getCharacter()
    local hrp = chr:WaitForChild("HumanoidRootPart")

    coroutine.wrap(function()
        local radius = 15
        local heightOffset = 3
        local speed = 2
        while _G.FlyWaypoint and boss and boss.Parent do
            local bossPos = boss.HumanoidRootPart.Position
            local angle = tick() * speed
            local x = bossPos.X + math.cos(angle) * radius
            local z = bossPos.Z + math.sin(angle) * radius
            local y = bossPos.Y + heightOffset
            hrp.CFrame = CFrame.new(Vector3.new(x, y, z), bossPos)
            task.wait(0.05)
        end
    end)()
end

-- ==== Auto nhặt item rơi ====
coroutine.wrap(function()
    while task.wait(0.5) do
        if _G.AutoItem then
            for _,v in pairs(Workspace:GetChildren()) do
                if v:IsA("Tool") or v.Name:lower():find("item") then
                    local hrp = getCharacter():WaitForChild("HumanoidRootPart")
                    hrp.CFrame = v.CFrame
                    firetouchinterest(hrp, v, 0)
                    firetouchinterest(hrp, v, 1)
                end
            end
        end
    end
end)()

-- ==== Hiện máu Boss & máu người chơi ====
local hpLabel = Instance.new("TextLabel", ScreenGui)
hpLabel.Size = UDim2.new(0,400,0,30)
hpLabel.Position = UDim2.new(0.3,0,0.05,0)
hpLabel.TextColor3 = Color3.new(1,0,0)
hpLabel.BackgroundTransparency = 1
hpLabel.TextScaled = true

coroutine.wrap(function()
    while task.wait(0.2) do
        local boss = getNearestBoss()
        if boss and boss:FindFirstChild("Humanoid") then
            local hp = math.floor(boss.Humanoid.Health)
            local maxhp = math.floor(boss.Humanoid.MaxHealth)
            hpLabel.Text = boss.Name.." : "..hp.."/"..maxhp
        else
            hpLabel.Text = "Không thấy Boss"
        end
    end
end)()

local playerHp = Instance.new("TextLabel", ScreenGui)
playerHp.Size = UDim2.new(0,200,0,30)
playerHp.Position = UDim2.new(0.7,0,0.05,0)
playerHp.TextColor3 = Color3.fromRGB(0,255,0)
playerHp.BackgroundTransparency = 1
playerHp.TextScaled = true

coroutine.wrap(function()
    while task.wait(0.2) do
        local hum = getCharacter():FindFirstChild("Humanoid")
        if hum then
            playerHp.Text = tostring(math.floor(hum.Health)).."/"..tostring(math.floor(hum.MaxHealth))
        end
    end
end)()

-- ==== Nút bấm ====
farmBtn.MouseButton1Click:Connect(function()
    _G.AutoFarm = not _G.AutoFarm
    farmBtn.Text = "Auto Farm Boss "..(_G.AutoFarm and "ON" or "OFF")
end)

flyBtn.MouseButton1Click:Connect(function()
    _G.FlyWaypoint = not _G.FlyWaypoint
    flyBtn.Text = "Bay Waypoint "..(_G.FlyWaypoint and "ON" or "OFF")
    if _G.FlyWaypoint then
        local boss = getNearestBoss()
        if boss then flyAroundBoss(boss) end
    end
end)

itemBtn.MouseButton1Click:Connect(function()
    _G.AutoItem = not _G.AutoItem
    itemBtn.Text = "Auto Nhặt Item "..(_G.AutoItem and "ON" or "OFF")
end)
